<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–æ–≥–∏–∫–∞ –∏ –°–µ–Ω—Å–æ—Ä–∏–∫–∞ v7.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- Global Styles --- */
        body { 
            font-family: 'Nunito', sans-serif; 
            overflow: hidden; 
            background-color: #E0F7FA;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.6) 0%, transparent 20%),
                radial-gradient(circle at 90% 10%, rgba(255, 255, 255, 0.5) 0%, transparent 15%),
                radial-gradient(circle at 30% 80%, rgba(255, 255, 255, 0.4) 0%, transparent 25%),
                linear-gradient(to bottom, #E1F5FE, #B3E5FC);
            background-size: cover;
            color: #37474F;
        }
        
        .game-title { 
            font-size: 3rem; 
            font-weight: 900; 
            color: #0277BD; 
            text-shadow: 2px 2px 0 #E1F5FE; 
            text-align: center;
            margin-bottom: 20px;
        }

        /* --- Menu Cards --- */
        .menu-grid { display: flex; justify-content: center; gap: 30px; margin-top: 50px; flex-wrap: wrap; }
        .menu-card {
            width: 280px; height: 220px;
            background: white;
            border-radius: 30px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 10px 25px rgba(2, 119, 189, 0.15);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            border: 5px solid transparent;
        }
        .menu-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(2, 119, 189, 0.25); border-color: #4FC3F7; }
        .card-icon { font-size: 4rem; margin-bottom: 15px; }
        .card-text { font-size: 1.4rem; font-weight: 800; color: #455A64; text-align: center; line-height: 1.2;}

        /* --- Game Container --- */
        .game-view { display: flex; flex-direction: column; height: 100vh; }
        .header { 
            padding: 15px 30px; 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .canvas { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        
        /* --- Controls --- */
        .btn-back { background: #FF7043; color: white; padding: 10px 20px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 0 #D84315; }
        .btn-back:active { transform: translateY(4px); box-shadow: 0 0 0 #D84315; }
        
        .settings-panel { display: flex; gap: 15px; align-items: center; background: white; padding: 10px 20px; border-radius: 20px; border: 2px solid #B3E5FC; }
        .toggle-group { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; font-weight: 700; cursor: pointer; }
        .checkbox { width: 20px; height: 20px; accent-color: #039BE5; }

        /* --- Game 1: Dienes Blocks --- */
        .dienes-container { transition: transform 0.3s; }
        
        /* Tower View Layouts */
        .tower-container {
            display: flex; flex-direction: column; gap: 20px; align-items: center; width: 100%;
        }
        .view-panel {
            background: rgba(255,255,255,0.8);
            border-radius: 20px;
            padding: 30px;
            border: 3px solid #B3E5FC;
            display: flex; justify-content: center; align-items: center;
            min-width: 300px;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .view-label {
            position: absolute; top: -15px; left: 20px;
            background: #0288D1; color: white;
            padding: 5px 15px; border-radius: 15px;
            font-size: 0.9rem; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Riddle Cards */
        .riddle-grid { display: flex; gap: 20px; margin-bottom: 30px; justify-content: center; width: 100%; max-width: 900px; flex-wrap: wrap; }
        .riddle-card {
            width: 140px; height: 140px;
            background: white; border: 3px solid #CFD8DC; border-radius: 15px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.05); overflow: hidden;
        }
        .negation-cross {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' preserveAspectRatio='none'><line x1='10' y1='10' x2='90' y2='90' stroke='%23D32F2F' stroke-width='8' stroke-linecap='round'/><line x1='90' y1='10' x2='10' y2='90' stroke='%23D32F2F' stroke-width='8' stroke-linecap='round'/></svg>") no-repeat center center;
            background-size: 80% 80%; opacity: 0.8; z-index: 10;
        }
        .card-label { position: absolute; bottom: 5px; font-size: 0.8rem; font-weight: bold; color: #90A4AE; text-transform: uppercase; }
        
        .shape-face { stroke: rgba(0,0,0,0.3); stroke-width: 2px; }
        .shape-side { stroke: rgba(0,0,0,0.3); stroke-width: 2px; filter: brightness(0.85); }

        /* --- Game 2: Color Code --- */
        .btn-3d {
            border-radius: 50%; transition: transform 0.1s;
            box-shadow: 0 8px 0 rgba(0,0,0,0.2), 0 15px 20px rgba(0,0,0,0.1);
            position: relative; border: 4px solid rgba(255,255,255,0.4);
            display: flex; justify-content: center; align-items: center;
        }
        .btn-number {
            position: absolute; top: -35px; font-size: 1.5rem; font-weight: 900; color: #546E7A;
            background: white; width: 40px; height: 40px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; z-index: 10;
        }
        .btn-red { background: #FF5252; box-shadow: 0 8px 0 #D32F2F; }
        .btn-yellow { background: #FFEB3B; box-shadow: 0 8px 0 #FBC02D; }
        .btn-blue { background: #2196F3; box-shadow: 0 8px 0 #1976D2; }
        .btn-green { background: #4CAF50; box-shadow: 0 8px 0 #388E3C; }
        .btn-pink { background: #F48FB1; box-shadow: 0 8px 0 #C2185B; }
        .btn-black { background: #37474F; box-shadow: 0 8px 0 #263238; }
        
        .seq-container { 
            display: flex; gap: 40px; padding: 60px; 
            background: rgba(255,255,255,0.7); border-radius: 40px; 
            transition: all 0.5s; align-items: center; justify-content: center; flex-wrap: wrap; max-width: 90%;
        }
        .seq-vertical { flex-direction: column; }
        .size-mode-lg { width: 100px; height: 100px; }
        .size-mode-sm { width: 60px; height: 60px; }
        .size-wrapper { width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; position: relative; }

        /* --- Game 3: Cups --- */
        .cup-card {
            width: 150px; height: 180px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            transition: transform 0.3s;
            border: 5px solid transparent;
        }
        .cup-card.border-red { border-color: #FF5252; }
        .cup-card.border-yellow { border-color: #FFEB3B; }
        .cup-card.border-blue { border-color: #2196F3; }
        
        .cup-content { font-size: 5rem; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }
        
        .cups-row { display: flex; gap: 30px; align-items: flex-end; }
        .cups-tower { display: flex; flex-direction: column-reverse; gap: 10px; }
        .cups-pyramid { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .pyramid-row { display: flex; gap: 10px; justify-content: center; }

        .hidden { display: none !important; }
        @keyframes pop { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop 0.5s ease-out forwards; }
    </style>
</head>
<body>

    <!-- Main Menu -->
    <div id="main-menu" class="h-screen flex flex-col items-center justify-center">
        <h1 class="game-title">–†–∞–∑–≤–∏–≤–∞–π–∫–∞: –õ–æ–≥–∏–∫–∞</h1>
        <div class="text-gray-500 font-bold mb-10 text-xl">–¢—Ä–µ–Ω–∞–∂–µ—Ä—ã –¥–ª—è —É–º–∞</div>
        
        <div class="menu-grid">
            <div onclick="openGame(1)" class="menu-card border-b-8 border-blue-400">
                <div class="card-icon">üî∑üî¥</div>
                <div class="card-text">–ë–ª–æ–∫–∏ –î—å–µ–Ω–µ—à–∞</div>
            </div>
            
            <div onclick="openGame(2)" class="menu-card border-b-8 border-green-400">
                <div class="card-icon">üé®üî¢</div>
                <div class="card-text">–¶–≤–µ—Ç–æ–≤–æ–π –ö–æ–¥</div>
            </div>

            <div onclick="openGame(3)" class="menu-card border-b-8 border-red-400">
                <div class="card-icon">ü•§üèóÔ∏è</div>
                <div class="card-text">–¶–≤–µ—Ç–Ω—ã–µ –°—Ç–∞–∫–∞–Ω—á–∏–∫–∏</div>
            </div>
        </div>
    </div>

    <!-- Game 1: Dienes Blocks -->
    <div id="game-1" class="game-view hidden">
        <div class="header">
            <button onclick="backToMenu()" class="btn-back"><i class="fas fa-arrow-left"></i> –ú–µ–Ω—é</button>
            <div class="settings-panel">
                <label class="toggle-group text-blue-600 bg-blue-50 px-3 py-1 rounded-full"><input type="checkbox" id="g1-tower" class="checkbox" onchange="toggleTowerMode()"> üèóÔ∏è –ë–∞—à–Ω—è (–°–≤–µ—Ä—Ö—É/–°–±–æ–∫—É)</label>
                <div class="border-l border-gray-300 mx-2 h-6"></div>
                <label class="toggle-group text-red-500 bg-red-50 px-3 py-1 rounded-full"><input type="checkbox" id="g1-negation" class="checkbox" onchange="toggleNegationSettings()"> üö´ –°—Ö–µ–º–∞ (–û—Ç—Ä–∏—Ü–∞–Ω–∏–µ)</label>
                
                <!-- Standard Props -->
                <div id="g1-props" class="flex gap-2 items-center ml-4">
                    <div class="border-l border-gray-300 mx-2 h-6"></div>
                    <label class="toggle-group"><input type="checkbox" id="g1-shape" checked class="checkbox"> –§–∏–≥—É—Ä–∞</label>
                    <label class="toggle-group"><input type="checkbox" id="g1-color" checked class="checkbox"> –¶–≤–µ—Ç</label>
                    <label class="toggle-group"><input type="checkbox" id="g1-size" class="checkbox"> –†–∞–∑–º–µ—Ä</label>
                    <label class="toggle-group"><input type="checkbox" id="g1-thick" class="checkbox"> –¢–æ–ª—â–∏–Ω–∞</label>
                </div>
            </div>
        </div>
        <div class="canvas flex-col" id="canvas-1"></div>
        <div class="text-center pb-5 text-gray-400 font-bold text-xl flex justify-center gap-4">
            <span>–ù–∞–∂–º–∏ –ü–†–û–ë–ï–õ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</span>
            <button id="g1-reveal-btn" class="hidden bg-blue-500 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-blue-600 transition" onclick="revealAnswer()">üëÅÔ∏è –û—Ç–≤–µ—Ç</button>
        </div>
    </div>

    <!-- Game 2: Color Code -->
    <div id="game-2" class="game-view hidden">
        <div class="header">
            <button onclick="backToMenu()" class="btn-back"><i class="fas fa-arrow-left"></i> –ú–µ–Ω—é</button>
            <div class="settings-panel">
                <label class="toggle-group"><input type="checkbox" id="g2-vertical" class="checkbox"> –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ</label>
                <div class="border-l border-gray-300 mx-2 h-6"></div>
                <label class="toggle-group bg-gray-100 px-2 rounded"><input type="radio" name="g2-mode" value="color" checked class="checkbox" onchange="toggleColorSelectors()"> –¶–≤–µ—Ç–∞</label>
                <label class="toggle-group bg-gray-100 px-2 rounded"><input type="radio" name="g2-mode" value="size" class="checkbox" onchange="toggleColorSelectors()"> –†–∞–∑–º–µ—Ä—ã</label>
                
                <!-- Color Selectors -->
                <div id="g2-colors-box" class="flex gap-2 ml-2 items-center bg-white border border-gray-200 rounded-lg px-2">
                    <label><input type="checkbox" value="btn-red" checked class="g2-color-cb w-5 h-5 accent-red-500"></label>
                    <label><input type="checkbox" value="btn-yellow" checked class="g2-color-cb w-5 h-5 accent-yellow-400"></label>
                    <label><input type="checkbox" value="btn-blue" checked class="g2-color-cb w-5 h-5 accent-blue-600"></label>
                    <label><input type="checkbox" value="btn-green" checked class="g2-color-cb w-5 h-5 accent-green-600"></label>
                    <label><input type="checkbox" value="btn-pink" checked class="g2-color-cb w-5 h-5 accent-pink-500"></label>
                </div>

                <div class="border-l border-gray-300 mx-2 h-6"></div>
                <span class="text-sm font-bold">–ö–æ–ª-–≤–æ:</span>
                <input type="range" id="g2-count" min="2" max="6" value="3" class="w-20">
            </div>
        </div>
        <div class="canvas" id="canvas-2"></div>
        <div class="text-center pb-5 text-gray-400 font-bold text-xl">–ù–∞–∂–º–∏ –ü–†–û–ë–ï–õ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
    </div>

    <!-- Game 3: Cups -->
    <div id="game-3" class="game-view hidden">
        <div class="header">
            <button onclick="backToMenu()" class="btn-back"><i class="fas fa-arrow-left"></i> –ú–µ–Ω—é</button>
            <div class="settings-panel">
                <label class="flex items-center space-x-1 cursor-pointer bg-blue-100 px-3 py-1 rounded-full hover:bg-blue-200 text-sm">
                    <i class="fas fa-camera text-blue-600"></i>
                    <span class="font-bold text-blue-700">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ (3 —à—Ç)</span>
                    <input type="file" id="upload-cups-input" multiple accept="image/*" class="hidden">
                </label>
                <div class="border-l border-gray-300 mx-2 h-6"></div>
                <span class="text-red-500 font-bold mr-2">–†–µ–∂–∏–º:</span>
                <label class="toggle-group bg-gray-100 px-2 rounded"><input type="radio" name="g3-mode" value="row" checked class="checkbox"> –†—è–¥</label>
                <label class="toggle-group bg-gray-100 px-2 rounded"><input type="radio" name="g3-mode" value="tower" class="checkbox"> –ë–∞—à–Ω—è</label>
                <label class="toggle-group bg-gray-100 px-2 rounded"><input type="radio" name="g3-mode" value="pyramid" class="checkbox"> –ü–∏—Ä–∞–º–∏–¥–∞</label>
                <div class="border-l border-gray-300 mx-2 h-6"></div>
                <span class="text-sm font-bold">–ö–æ–ª-–≤–æ:</span>
                <input type="range" id="g3-count" min="3" max="6" value="3" class="w-20">
            </div>
        </div>
        <div class="canvas" id="canvas-3"></div>
        <div class="text-center pb-5 text-gray-400 font-bold text-xl">–ù–∞–∂–º–∏ –ü–†–û–ë–ï–õ –¥–ª—è –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã</div>
    </div>

    <script>
        let currentGame = 0;
        let currentAnswerSvg = ''; 
        let customCupImages = []; 

        // Data
        const shapes = ['circle', 'square', 'triangle', 'rect'];
        const colorsDienes = [
            { hex: '#FF5252', name: '–ö—Ä–∞—Å–Ω—ã–π' }, 
            { hex: '#FFEB3B', name: '–ñ–µ–ª—Ç—ã–π' }, 
            { hex: '#2196F3', name: '–°–∏–Ω–∏–π' }
        ]; 
        
        const cupsPalette = [
            { id: 'red', border: 'border-red', content: '<i class="fas fa-cube text-red-500 cup-content"></i>' }, 
            { id: 'yellow', border: 'border-yellow', content: '<i class="fas fa-star text-yellow-400 cup-content"></i>' }, 
            { id: 'blue', border: 'border-blue', content: '<i class="fas fa-shapes text-blue-500 cup-content"></i>' } 
        ];

        // Navigation
        function openGame(id) {
            currentGame = id;
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById(`game-${id}`).classList.remove('hidden');
            generate();
        }

        function backToMenu() {
            document.getElementById(`game-${currentGame}`).classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            currentGame = 0;
        }

        document.addEventListener('keydown', (e) => {
            if (currentGame === 0) return;
            if (e.code === 'Space' || e.code === 'ArrowRight') {
                e.preventDefault();
                generate();
            }
        });

        document.querySelectorAll('input').forEach(el => {
            if(el.type !== 'file') {
                el.addEventListener('change', () => {
                    // Logic to avoid double clicks
                    if(currentGame !== 0 && el.id !== 'g1-negation' && el.id !== 'g1-tower') generate();
                });
            }
        });
        
        document.getElementById('upload-cups-input').addEventListener('change', (e) => {
            const files = e.target.files;
            if(files.length > 0) {
                customCupImages = [];
                for(let i=0; i<Math.min(files.length, 3); i++) {
                    customCupImages.push(URL.createObjectURL(files[i]));
                }
                alert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${customCupImages.length} –∫–∞—Ä—Ç–∏–Ω–∫–∏!`);
                if(currentGame === 3) generateCups();
            }
        });

        function toggleNegationSettings() {
            document.getElementById('g1-tower').checked = false; // Exclusive
            const isNeg = document.getElementById('g1-negation').checked;
            const propsDiv = document.getElementById('g1-props');
            if(isNeg) {
               propsDiv.classList.add('opacity-50', 'pointer-events-none');
               document.getElementById('g1-shape').checked = true;
               document.getElementById('g1-color').checked = true;
               document.getElementById('g1-size').checked = true;
               document.getElementById('g1-thick').checked = true;
            } else {
               propsDiv.classList.remove('opacity-50', 'pointer-events-none');
            }
            generateDienes();
        }

        function toggleTowerMode() {
            document.getElementById('g1-negation').checked = false; // Exclusive
            const propsDiv = document.getElementById('g1-props');
            if(document.getElementById('g1-tower').checked) {
                propsDiv.classList.add('opacity-50', 'pointer-events-none');
            } else {
                propsDiv.classList.remove('opacity-50', 'pointer-events-none');
            }
            generateDienes();
        }
        
        function toggleColorSelectors() {
            const mode = document.querySelector('input[name="g2-mode"]:checked').value;
            const box = document.getElementById('g2-colors-box');
            if (mode === 'size') {
                box.classList.add('opacity-30', 'pointer-events-none');
            } else {
                box.classList.remove('opacity-30', 'pointer-events-none');
            }
            generateCode();
        }

        function generate() {
            if(currentGame === 1) generateDienes();
            if(currentGame === 2) generateCode();
            if(currentGame === 3) generateCups();
        }

        // --- Game 1: Dienes ---
        function generateDienes() {
            const canvas = document.getElementById('canvas-1');
            const btnReveal = document.getElementById('g1-reveal-btn');
            
            const useShape = document.getElementById('g1-shape').checked;
            const useColor = document.getElementById('g1-color').checked;
            const useSize = document.getElementById('g1-size').checked;
            const useThick = document.getElementById('g1-thick').checked;
            const useNegation = document.getElementById('g1-negation').checked;
            const useTower = document.getElementById('g1-tower').checked;

            // Helper to generate a random block
            const getRandomBlock = () => {
                return {
                    shape: shapes[Math.floor(Math.random() * shapes.length)],
                    colorObj: colorsDienes[Math.floor(Math.random() * 3)],
                    isLarge: Math.random() > 0.5,
                    isThick: Math.random() > 0.5
                };
            };

            // Helper to Draw SVG
            const getBlockSVG = (block, viewMode = '3d', offsetX = 0, offsetY = 0) => {
                const depth = block.isThick ? (viewMode === 'top' ? 0 : 50) : (viewMode === 'top' ? 0 : 10);
                const sizeScale = block.isLarge ? 1.0 : 0.6; 
                const fill = block.colorObj.hex;
                const cx = 100 + offsetX;
                const cy = 100 + offsetY;
                
                let s = '';
                
                if (viewMode === 'top') {
                    // Flat Top View
                    if (block.shape === 'circle') s += `<circle cx="${cx}" cy="${cy}" r="${70*sizeScale}" fill="${fill}" stroke="#333" stroke-width="2" fill-opacity="0.9"/>`;
                    else if (block.shape === 'square') s += `<rect x="${cx - 60*sizeScale}" y="${cy - 60*sizeScale}" width="${120*sizeScale}" height="${120*sizeScale}" fill="${fill}" stroke="#333" stroke-width="2" fill-opacity="0.9"/>`;
                    else if (block.shape === 'rect') s += `<rect x="${cx - 80*sizeScale}" y="${cy - 40*sizeScale}" width="${160*sizeScale}" height="${80*sizeScale}" fill="${fill}" stroke="#333" stroke-width="2" fill-opacity="0.9"/>`;
                    else if (block.shape === 'triangle') s += `<polygon points="${cx},${cy - 70*sizeScale} ${cx + 70*sizeScale},${cy + 50*sizeScale} ${cx - 70*sizeScale},${cy + 50*sizeScale}" fill="${fill}" stroke="#333" stroke-width="2" fill-opacity="0.9"/>`;
                } 
                else if (viewMode === 'side_profile') {
                    // Side 3D profile for Tower
                    const h = block.isThick ? 60 : 15;
                    const w = block.isLarge ? 120 : 70;
                    
                    // Simple prism for side view
                    // Front face
                    s += `<rect x="${cx-w/2}" y="${cy-h/2}" width="${w}" height="${h}" fill="${fill}" stroke="#333" stroke-width="1" />`;
                    // Top Face (Depth)
                    s += `<path d="M${cx-w/2},${cy-h/2} L${cx-w/2+10},${cy-h/2-10} L${cx+w/2+10},${cy-h/2-10} L${cx+w/2},${cy-h/2} Z" fill="${fill}" stroke="#333" stroke-width="1" />`;
                    // Right Face
                    s += `<path d="M${cx+w/2},${cy-h/2} L${cx+w/2+10},${cy-h/2-10} L${cx+w/2+10},${cy+h/2-10} L${cx+w/2},${cy+h/2} Z" fill="${fill}" stroke="#333" stroke-width="1" />`;
                }
                else {
                    // 3D View (Standard Single) - logic from v7 used if needed
                }
                return s;
            };

            // --- TOWER MODE (Top View -> 3D Side Tower) ---
            if (useTower) {
                btnReveal.classList.remove('hidden');
                
                const blocks = [getRandomBlock(), getRandomBlock(), getRandomBlock()];
                
                // 1. Top View (Overlay)
                let topViewSvg = '';
                blocks.forEach((b, i) => {
                    const offX = (i - 1) * 20; // -20, 0, 20
                    const offY = (i - 1) * 10;
                    topViewSvg += getBlockSVG(b, 'top', offX, offY);
                });
                
                let topHtml = `<div class="view-panel"><div class="view-label">–í–ò–î –°–í–ï–†–•–£</div>
                                <svg width="250" height="250" viewBox="0 0 200 200">${topViewSvg}</svg>
                               </div>`;

                // 2. Side View (Tower) - Answer
                let currentY = 220; 
                let towerSvg = '';
                
                blocks.forEach((b, i) => {
                    const h = b.isThick ? 60 : 15;
                    const w = b.isLarge ? 120 : 70;
                    const fill = b.colorObj.hex;
                    const cx = 100;
                    
                    const offX = (i - 1) * 20;
                    const yPos = currentY - h;
                    
                    towerSvg += `<rect x="${cx+offX-w/2}" y="${yPos}" width="${w}" height="${h}" fill="${fill}" stroke="#333" stroke-width="1" />`;
                    towerSvg += `<path d="M${cx+offX-w/2},${yPos} L${cx+offX-w/2+10},${yPos-10} L${cx+offX+w/2+10},${yPos-10} L${cx+offX+w/2},${yPos} Z" fill="${fill}" stroke="#333" stroke-width="1" />`;
                    towerSvg += `<path d="M${cx+offX+w/2},${yPos} L${cx+offX+w/2+10},${yPos-10} L${cx+offX+w/2+10},${yPos+h-10} L${cx+offX+w/2},${yPos+h} Z" fill="${fill}" stroke="#333" stroke-width="1" />`;
                    
                    currentY = yPos - 10; 
                });
                
                let sideHtml = `<div class="view-panel"><div class="view-label">–û–¢–í–ï–¢ (–°–ë–û–ö–£)</div>
                                  <svg width="250" height="300" viewBox="0 0 200 300">${towerSvg}</svg>
                                </div>`;

                canvas.innerHTML = `
                    <div class="tower-container animate-pop">
                        ${topHtml}
                        <div id="answer-view" class="hidden mt-4">
                            ${sideHtml}
                        </div>
                    </div>
                `;
                return;
            }

            // --- LOGIC SCHEME MODE (Negation) ---
            if (useNegation) {
                const block = getRandomBlock();
                btnReveal.classList.remove('hidden');
                
                const depth = block.isThick ? 60 : 10;
                const sizeScale = block.isLarge ? 1.2 : 0.7;
                const fill = block.colorObj.hex;
                const cx = 200, cy = 200;
                let s3d = '';
                
                 if (block.shape === 'circle') {
                    const r = 70 * sizeScale;
                    s3d += `<path d="M${cx-r},${cy} A${r},${r/2} 0 0,0 ${cx+r},${cy} L${cx+r},${cy+depth} A${r},${r/2} 0 0,1 ${cx-r},${cy+depth} Z" fill="${fill}" class="shape-side" />`;
                    s3d += `<ellipse cx="${cx}" cy="${cy}" rx="${r}" ry="${r/2}" fill="${fill}" class="shape-face" />`;
                } else {
                    const w = 120 * sizeScale; const x = cx - w/2; const y = cy - w/3;
                    s3d += `<path d="M${x+w},${y} L${x+w+depth/2},${y-depth/2} L${x+w+depth/2},${y+w-depth/2} L${x+w},${y+w} Z" fill="${fill}" class="shape-side" />`;
                    s3d += `<path d="M${x},${y} L${x+depth/2},${y-depth/2} L${x+w+depth/2},${y-depth/2} L${x+w},${y} Z" fill="${fill}" class="shape-side" />`;
                    s3d += `<rect x="${x}" y="${y}" width="${w}" height="${w}" fill="${fill}" class="shape-face" />`;
                }

                // Generate Cards (Negation Logic)
                let riddleCards = '';
                const createCard = (html, isNot, label) => `
                    <div class="riddle-card animate-pop">
                        <div class="flex items-center justify-center h-full w-full p-2">${html}</div>
                        ${isNot ? '<div class="negation-cross"></div>' : ''}
                        <div class="card-label">${label}</div>
                    </div>`;
                
                // Color Card
                let isNotC = Math.random() > 0.3;
                let dispC = block.colorObj.hex;
                if(isNotC) {
                    const others = colorsDienes.filter(c => c.hex !== block.colorObj.hex);
                    dispC = others[Math.floor(Math.random()*others.length)].hex;
                }
                riddleCards += createCard(`<div class="w-16 h-16 rounded-full" style="background:${dispC}"></div>`, isNotC, '–¶–≤–µ—Ç');

                // Shape Card
                let isNotS = Math.random() > 0.3;
                let dispS = block.shape;
                if(isNotS) {
                    const others = shapes.filter(s => s !== block.shape);
                    dispS = others[Math.floor(Math.random()*others.length)];
                }
                let iconS = '';
                if(dispS==='circle') iconS='<div class="w-12 h-12 rounded-full bg-gray-400"></div>';
                if(dispS==='square') iconS='<div class="w-12 h-12 bg-gray-400"></div>';
                if(dispS==='triangle') iconS='<div style="width:0;height:0;border-left:25px solid transparent;border-right:25px solid transparent;border-bottom:50px solid #9CA3AF;"></div>';
                if(dispS==='rect') iconS='<div class="w-16 h-10 bg-gray-400"></div>';
                riddleCards += createCard(iconS, isNotS, '–§–∏–≥—É—Ä–∞');

                // Size
                let isNotSz = Math.random() > 0.3;
                let showLg = block.isLarge;
                if(isNotSz) showLg = !block.isLarge;
                const iconSz = showLg ? '<i class="fas fa-building text-5xl text-gray-600"></i>' : '<i class="fas fa-home text-3xl text-gray-600"></i>';
                riddleCards += createCard(iconSz, isNotSz, '–†–∞–∑–º–µ—Ä');

                // Thick
                let isNotTh = Math.random() > 0.3;
                let showTh = block.isThick;
                if(isNotTh) showTh = !block.isThick;
                const iconTh = showTh ? '<i class="fas fa-child text-5xl text-gray-700" style="transform: scaleX(2.5);"></i>' : '<i class="fas fa-child text-5xl text-gray-700" style="transform: scaleX(0.7);"></i>';
                riddleCards += createCard(iconTh, isNotTh, '–¢–æ–ª—â–∏–Ω–∞');

                canvas.innerHTML = `
                    <div id="riddle-view" class="flex flex-col items-center justify-center flex-grow"><div class="riddle-grid">${riddleCards}</div></div>
                    <div id="answer-view" class="hidden animate-pop flex-grow flex items-center justify-center">
                        <div class="dienes-container relative flex justify-center items-center" style="width: 400px; height: 400px;">
                            <svg viewBox="0 0 400 400" style="overflow: visible; width:100%; height:100%;">${s3d}</svg>
                        </div>
                    </div>
                `;

            } else {
                // SINGLE MODE
                btnReveal.classList.add('hidden');
                const block = getRandomBlock();
                const depth = block.isThick ? 60 : 10;
                const sizeScale = block.isLarge ? 1.2 : 0.7;
                const fill = block.colorObj.hex;
                const cx = 200, cy = 200;
                
                let s3d = '';
                 if (block.shape === 'circle') {
                    const r = 70 * sizeScale;
                    s3d += `<path d="M${cx-r},${cy} A${r},${r/2} 0 0,0 ${cx+r},${cy} L${cx+r},${cy+depth} A${r},${r/2} 0 0,1 ${cx-r},${cy+depth} Z" fill="${fill}" class="shape-side" />`;
                    s3d += `<ellipse cx="${cx}" cy="${cy}" rx="${r}" ry="${r/2}" fill="${fill}" class="shape-face" />`;
                } else {
                    // Fallback
                    const w = 120 * sizeScale; const x = cx - w/2; const y = cy - w/3;
                    s3d += `<path d="M${x+w},${y} L${x+w+depth/2},${y-depth/2} L${x+w+depth/2},${y+w-depth/2} L${x+w},${y+w} Z" fill="${fill}" class="shape-side" />`;
                    s3d += `<path d="M${x},${y} L${x+depth/2},${y-depth/2} L${x+w+depth/2},${y-depth/2} L${x+w},${y} Z" fill="${fill}" class="shape-side" />`;
                    s3d += `<rect x="${x}" y="${y}" width="${w}" height="${w}" fill="${fill}" class="shape-face" />`;
                }

                canvas.innerHTML = `
                    <div class="dienes-container relative flex justify-center items-center animate-pop flex-grow" style="width: 400px; height: 400px;">
                        <svg viewBox="0 0 400 400" style="overflow: visible; width:100%; height:100%;">${s3d}</svg>
                    </div>
                `;
            }
        }

        function revealAnswer() {
            document.getElementById('riddle-view')?.classList.add('hidden');
            document.getElementById('answer-view').classList.remove('hidden');
        }

        // --- Game 2: Color Code ---
        function generateCode() {
            const canvas = document.getElementById('canvas-2');
            const isVertical = document.getElementById('g2-vertical').checked;
            const mode = document.querySelector('input[name="g2-mode"]:checked').value;
            const count = parseInt(document.getElementById('g2-count').value);

            let html = `<div class="seq-container ${isVertical ? 'seq-vertical' : ''}">`;

            if (mode === 'color') {
                // Collect checked colors
                const checkedBoxes = document.querySelectorAll('.g2-color-cb:checked');
                let availableColors = Array.from(checkedBoxes).map(cb => cb.value);
                if (availableColors.length === 0) availableColors = ['btn-red']; // Fallback

                for(let i=0; i<count; i++) {
                    const c = availableColors[Math.floor(Math.random() * availableColors.length)];
                    html += `<div class="size-wrapper animate-pop" style="animation-delay: ${i*0.1}s"><div class="btn-3d ${c} size-mode-lg"><div class="btn-number">${i+1}</div></div></div>`;
                }
            } else {
                for(let i=0; i<count; i++) {
                    const isBig = Math.random() > 0.5;
                    const sizeClass = isBig ? 'size-mode-lg' : 'size-mode-sm';
                    html += `<div class="size-wrapper animate-pop" style="animation-delay: ${i*0.1}s"><div class="btn-3d btn-black ${sizeClass} flex items-center justify-center"><div class="btn-number">${i+1}</div></div></div>`;
                }
            }
            html += `</div>`;
            canvas.innerHTML = html;
        }

        // --- Game 3: Colored Cups ---
        function generateCups() {
            const canvas = document.getElementById('canvas-3');
            const mode = document.querySelector('input[name="g3-mode"]:checked').value;
            const count = parseInt(document.getElementById('g3-count').value);
            
            let html = '';
            
            const getUniqueColors = (n) => {
                let pool = [...cupsPalette];
                let result = [];
                for(let i=0; i<n; i++) {
                    if(pool.length === 0) pool = [...cupsPalette]; 
                    const idx = Math.floor(Math.random() * pool.length);
                    if(result.length > 0 && pool[idx].id === result[result.length-1].id && pool.length > 1) {
                        const nextIdx = (idx + 1) % pool.length;
                        result.push(pool[nextIdx]);
                        pool.splice(nextIdx, 1);
                    } else {
                        result.push(pool[idx]);
                        pool.splice(idx, 1);
                    }
                }
                return result;
            };

            const createCup = (colorObj, delay) => {
                let content = '';
                if(customCupImages.length > 0) {
                    let imgIdx = 0;
                    if(colorObj.id === 'red') imgIdx = 0;
                    if(colorObj.id === 'yellow') imgIdx = 1;
                    if(colorObj.id === 'blue') imgIdx = 2;
                    if(imgIdx >= customCupImages.length) imgIdx = 0;
                    
                    content = `<img src="${customCupImages[imgIdx]}" class="cup-img">`;
                } else {
                    content = colorObj.content;
                }
                return `<div class="cup-card ${colorObj.border} animate-pop" style="animation-delay:${delay}s">
                            ${content}
                        </div>`;
            };
            
            if (mode === 'row') {
                const colors = getUniqueColors(count);
                html = `<div class="cups-row">`;
                colors.forEach((c, i) => html += createCup(c, i*0.1));
                html += `</div>`;
            } else if (mode === 'tower') {
                const colors = getUniqueColors(count);
                html = `<div class="cups-tower">`;
                colors.forEach((c, i) => html += createCup(c, i*0.1));
                html += `</div>`;
            } else if (mode === 'pyramid') {
                html = `<div class="cups-pyramid">`;
                for(let row=count; row>=1; row--) {
                    const rowColors = getUniqueColors(row); 
                    html += `<div class="pyramid-row">`;
                    rowColors.forEach((c, i) => {
                        html += createCup(c, (count-row)*0.1);
                    });
                    html += `</div>`;
                }
                html += `</div>`;
            }

            canvas.innerHTML = html;
        }

    </script>
</body>
</html>